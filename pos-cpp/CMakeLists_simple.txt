cmake_minimum_required(VERSION 3.16)
project(PersonalOntologySystem VERSION 1.0.0 LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# 查找基本依赖
find_package(Threads REQUIRED)
find_package(CURL REQUIRED)

# FetchContent for header-only libraries
include(FetchContent)

# nlohmann/json
FetchContent_Declare(
    json
    GIT_REPOSITORY https://github.com/nlohmann/json.git
    GIT_TAG v3.11.2
    GIT_SHALLOW TRUE
)
FetchContent_MakeAvailable(json)

# Crow (HTTP server)
FetchContent_Declare(
    crow
    GIT_REPOSITORY https://github.com/CrowCpp/Crow.git
    GIT_TAG v1.0+5
    GIT_SHALLOW TRUE
)
FetchContent_MakeAvailable(crow)

# spdlog
FetchContent_Declare(
    spdlog
    GIT_REPOSITORY https://github.com/gabime/spdlog.git
    GIT_TAG v1.12.0
    GIT_SHALLOW TRUE
)
FetchContent_MakeAvailable(spdlog)

# 源文件 - 简化版本，不包含需要RocksDB的代码
set(CORE_SOURCES
    src/core/common/types.cpp
    # 暂时跳过需要外部库的组件
    # src/core/ontology/ontology_graph.cpp
    # src/core/memory/memory_store.cpp
)

set(ML_SOURCES
    src/ml/ml_service_client.cpp
)

# 创建一个最小可运行的测试程序
add_executable(pos_test 
    src/core/common/types.cpp
    tests/test_basic.cpp
)

target_include_directories(pos_test PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}/src
)

target_link_libraries(pos_test PRIVATE
    Threads::Threads
    nlohmann_json::nlohmann_json
    spdlog::spdlog
)

# 完整服务器（需要外部库）
if(BUILD_FULL_SERVER)
    find_package(yaml-cpp QUIET)
    find_package(RocksDB QUIET)
    find_package(Boost 1.70 QUIET COMPONENTS geometry)
    
    if(yaml-cpp_FOUND AND RocksDB_FOUND AND Boost_FOUND)
        add_executable(pos_server 
            ${CORE_SOURCES}
            src/core/ontology/ontology_graph.cpp
            src/core/memory/memory_store.cpp
            ${ML_SOURCES}
            src/api/http_server.cpp
            src/main.cpp
        )
        
        target_include_directories(pos_server PRIVATE
            ${CMAKE_CURRENT_SOURCE_DIR}/src
        )
        
        target_link_libraries(pos_server PRIVATE
            Threads::Threads
            CURL::libcurl
            yaml-cpp
            rocksdb
            nlohmann_json::nlohmann_json
            Crow::Crow
            spdlog::spdlog
            Boost::geometry
        )
    else()
        message(WARNING "Missing dependencies for full server. Only building test.")
    endif()
endif()

message(STATUS "")
message(STATUS "Personal Ontology System Configuration:")
message(STATUS "  Version: ${PROJECT_VERSION}")
message(STATUS "  C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "")
